
@using Sipcon.WebApp.Client.Models
@using Sipcon.WebApp.Client.Enum
@using Sipcon.WebApp.Client.Services

@inject ISecurityService SecurityService


<MudDataGrid @ref="_accessGroupDetailGrid"
             T="AccessGroupDetail"
             ServerData="ServerReload"
             Striped="true"
             Dense="true"
             Hover="true"
             Filterable="false"
             FixedHeader Height="calc(100vh - 400px)"
             @bind-CurrentPage="_CurrentPage">
        <ToolBarContent>
            <MudTextField T="string" Placeholder="Buscar" Adornment="Adornment.Start" ValueChanged="@(s => OnSearch(s))" Value="_searchString" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
            <MudSpacer />
            <MudIconButton Icon="@Icons.Material.Filled.Refresh" Color="Color.Info" OnClick="ClickRefreshCatalog"></MudIconButton>
        </ToolBarContent>
        <Columns>
            <TemplateColumn T="AccessGroupDetail" Title="MODULO">
                <CellTemplate>
                    <MudText Typo="Typo.caption" Inline="true" Color="Color.Primary" Style="font-weight:bold;">@context.Item.Module.ToUpper()</MudText>
                </CellTemplate>
            </TemplateColumn>
            <TemplateColumn T="AccessGroupDetail" Title="ACCION">
                <CellTemplate>
                    <MudText Typo="Typo.caption" Inline="true" Style="font-weight:bold;font-style:italic">
                        @context.Item.ActionDisplay.ToUpper()
                    </MudText>
                </CellTemplate>
            </TemplateColumn>
            <TemplateColumn T="AccessGroupDetail" Title="">
                <CellTemplate>
                    <div class="d-flex justify-center">
                        @if (context.Item.Assign)
                        {
                            string style = "";
                            style += "color:#fff";
                            style += ";background-color:#00ca5f";
                            style += ";font-size: 11px";
                            style += ";font-style:italic";

                            <MudChip T="string" Style="@style" Label="true" Disabled="true">
                                ASIGNADO
                            </MudChip>
                        }
                        else
                        {
                            string style = "";
                            style += "color:#fff";
                            style += ";background-color:#757575";
                            style += ";font-size: 11px";
                            style += ";font-style:italic";

                            <MudChip T="string" Style="@style" Label="true" Disabled="true">
                                DESASIGNADO
                            </MudChip>

                        }


                    </div>
                </CellTemplate>
            </TemplateColumn>
            <TemplateColumn>
                <CellTemplate>
                    <MudSwitch T="bool" @bind-Value="context.Item.Assign" @bind-Value:after="() => AfterSupplierValueChange(context.Item)" Label="" LabelPlacement="Placement.End" Color="Color.Success" />
                </CellTemplate>
            </TemplateColumn>
        </Columns>
        <PagerContent>
            <MudDataGridPager T="AccessGroupDetail" PageSizeOptions="new int[] { 100 }" InfoFormat="{first_item}-{last_item} de {all_items}" RowsPerPageString="Registros por Pagina" />
        </PagerContent>
    </MudDataGrid>




@code {

    [Parameter] public int? IdAccessGroup { get; set; }
    
    private MudDataGrid<AccessGroupDetail>? _accessGroupDetailGrid;

    private string _searchString = string.Empty;
    private int _CurrentPage = 0;
    private int _rowCount = 0;
    private int _rowsTotal = 0;

    private async Task OnSearch(string text)
    {
        if (text.Length == 0 || text.Length >= 3)
        {
            _searchString = text;
            await _accessGroupDetailGrid!.ReloadServerData();
        }
    }

    private async Task ClickRefreshCatalog(MouseEventArgs ev)
    {
        _searchString = string.Empty;
        await _accessGroupDetailGrid!.ReloadServerData();
    }


    Func<AccessGroupDetail, object> GetSortKeySelector(string sortByPropertyName) => sortByPropertyName switch
    {
        nameof(AccessGroupDetail.Module) => o => o.Module ?? "",
        nameof(AccessGroupDetail.Action) => o => o.Action ?? "",
        _ => null! //o => o.Id ?? 0 // Criterio de ordenación por defecto
    };


    private async Task<GridData<AccessGroupDetail>> ServerReload(GridState<AccessGroupDetail> state)
    {
       
        _rowCount = state.Page * state.PageSize;
        IEnumerable<AccessGroupDetail> _details = new List<AccessGroupDetail>();
        var serviceResponse = await SecurityService.GetAccessGroupDetails(IdAccessGroup ?? 0, _rowCount, _searchString);

        if (serviceResponse.Processed)
        {
            _details = serviceResponse.Data;
            _rowsTotal = serviceResponse.Total;
           
        }
        else
        {
            _details = new List<AccessGroupDetail>();
            _rowsTotal = 0;
        }

        return new GridData<AccessGroupDetail> { TotalItems = _rowsTotal, Items = _details };

    }


    private async Task AfterSupplierValueChange(AccessGroupDetail detail)
    {
        var serviceResponse = await SecurityService.UpdateAccessGroupDetail(detail, Useful.userId);
        if (!serviceResponse.Processed)
        {
            await _accessGroupDetailGrid!.ReloadServerData();
        }
        await Task.CompletedTask;
    }
   
   
}
