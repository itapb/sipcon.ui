<MudGrid Spacing="0">
                <MudItem xs="12">
                    <MudPaper Elevation="2" Class="jpv1-dialog-background-title pa-3" Square="true">
                    <MudPaper Elevation="2" Class="pa-2 mud-text-align-center">
                        <MudStack Row="true" StretchItems="StretchItems.Start" Justify="Justify.FlexEnd">
                            <MudStack Row="true">
                                <MudText Typo="Typo.h6" Color="Color.Info">Catalogo de Inventario</MudText>
                            </MudStack>
                            <MudStack>
                               <MudFab Color="Color.Info" StartIcon="@Icons.Material.Filled.Close" Size="Size.Small" OnClick="CloseClick" />
                            </MudStack>
                        </MudStack>
                    </MudPaper></MudPaper>
                </MudItem>
                <MudItem xs="12">
<MudDataGrid @ref="InventoryCatalogMudDataGrid" T="Inventory" ServerData="ServerReload" Striped="true" Hover="true" Filterable="false" FixedHeader Height="calc(100vh - 280px)" @bind-CurrentPage="ContactCurrentPage">
    <ToolBarContent>       
        <MudTextField T="string" Placeholder="Buscar" Adornment="Adornment.Start" ValueChanged="@(s => OnSearch(s))" Value="searchString" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
        <MudSpacer />
        <MudIconButton Icon="@Icons.Material.Filled.Refresh" Color="Color.Info" OnClick="ClickRefreshInventoryCatalog"></MudIconButton>
    </ToolBarContent>
    <Columns>
        <PropertyColumn Property="x => x.PartInnerCode" Title="Codigo Parte" />
        <PropertyColumn Property="x => x.PartName" Title="Descripcion" />
        <PropertyColumn Property="x => x.Price" Title="Precio" />
        <PropertyColumn Property="x => x.Stock" Title="Existencia" />
        <PropertyColumn Property="x => x.LocationName" Title="Ubicacion" />
        <TemplateColumn>
            <CellTemplate>
                <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Add" OnClick="() => ClickAddInventory(context.Item)" />
            </CellTemplate>
        </TemplateColumn>
    </Columns>
    <PagerContent>
        <MudDataGridPager T="Inventory" PageSizeOptions="new int[] { 100 }" InfoFormat="{first_item}-{last_item} de {all_items}" RowsPerPageString="Registros por Pagina" />
    </PagerContent>
</MudDataGrid>
</MudItem>
</MudGrid>
@code {
    [Inject] private HttpClient Http { get; set; } = default!;
    [Inject] private IDialogService DialogService { get; set; } = default!;
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = default!;   
    [Parameter] public int? MovementId { get; set; }
   
    private MudDataGrid<Inventory>? InventoryCatalogMudDataGrid;

    
    bool _loading = true;
    string searchString = "";
    private int ContactCurrentPage = 0;

    private async Task OnSearch(string text)
    {
        if (text.Length == 0 || text.Length >= 3)
        {
            _loading = true;
            searchString = text;
            await InventoryCatalogMudDataGrid!.ReloadServerData();
        }
    }
    Func<Inventory, object> GetSortKeySelector(string sortByPropertyName) => sortByPropertyName switch
    {
        nameof(Inventory.PartInnerCode) => o => o.PartInnerCode ?? "",
        nameof(Inventory.PartName) => o => o.PartName ?? "",
        nameof(Inventory.Price) => o => o.Price ?? 0m,
        nameof(Inventory.Stock) => o => o.Stock ?? 0m,
        nameof(Inventory.LocationName) => o => o.LocationName ?? "",
        _ => null! //o => o.Id ?? 0 // Criterio de ordenación por defecto
    };
    private async Task<GridData<Inventory>> ServerReload(GridState<Inventory> state)
    {        
        _loading = true;
        var totalItems = 0;
        var mOffset = state.Page * state.PageSize;
        IEnumerable<Inventory> data;
        HttpResponseMessage response = await Http.GetAsync($"api/Inventory/GetAll?rowFrom={mOffset}&filter={searchString}&userId={Useful.userId}&supplierId={Useful.supplierId}");
        if (response.IsSuccessStatusCode)
        {
            var content2 = await response.Content.ReadFromJsonAsync<WebApiResponse<List<Inventory>>>();
            totalItems = content2!.total ?? 0;
            data = content2!.data ?? new List<Inventory>();
        }
        else
        {
            var errorMessage = await response.Content.ReadAsStringAsync();
            throw new Exception(errorMessage);
        }
        if (state.SortDefinitions.FirstOrDefault() is SortDefinition<Inventory> sortDefinition)
        {
            data = data.OrderByDirection(sortDefinition.Descending ? SortDirection.Descending : SortDirection.Ascending, GetSortKeySelector(sortDefinition.SortBy));
        }
        _loading = false;
        return new GridData<Inventory> { TotalItems = totalItems, Items = data };
    }  
   
    private async Task ClickAddInventory(Inventory item)
    {
        var options = new DialogOptions { MaxWidth = MaxWidth.Large, BackdropClick = false, NoHeader = true };
        NewMovementDetail AnewMovementDetail = new NewMovementDetail
        {
            Id = 0,
            PartId = item.PartId,
            MovementId = MovementId ,
            LocationId = item.LocationId,
            Stock = item.Stock,
        };
        var dialogReference = await DialogService.ShowAsync<InventoryToMovementDetail>("", new DialogParameters { ["newMovementDetail"] = AnewMovementDetail }, options);
        var dialogResult = await dialogReference.Result;
        await Task.CompletedTask;
    }
    private void CloseClick(MouseEventArgs args) => MudDialog?.Close(DialogResult.Ok(true));
    private async Task ClickRefreshInventoryCatalog(MouseEventArgs ev) => await InventoryCatalogMudDataGrid!.ReloadServerData();
}
