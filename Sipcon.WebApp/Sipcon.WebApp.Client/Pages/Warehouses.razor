@page "/warehouses"
<CustomBreadcrumbs mItems="ItemsNavigate"></CustomBreadcrumbs>
<InputFile OnChange="masterComp.OnInputFileChange" accept=".xlsx" style="display:none" />
@if (WarehouseId == null)
{
    <MudDataGrid @ref="masterComp.EntityMudDataGrid" T="Warehouse" ServerData="ServerReload" Filterable="false" FixedHeader Height="calc(100vh - 260px)" Loading="masterComp.loading" @bind-CurrentPage="masterComp.CurrentPage">
        <ToolBarContent>
            <MudIconButton Icon="@Icons.Material.Filled.AddCard" OnClick="masterComp.ClickAdd" Color="Color.Info"></MudIconButton>
            <MudTextField T="string" Placeholder="Buscar" Adornment="Adornment.Start" ValueChanged="@(s => masterComp.OnSearch(s))" Value="masterComp.searchString" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
            <MudSpacer />
            <MudIconButton Icon="@Icons.Material.Filled.Refresh" Color="Color.Info" OnClick="masterComp.ClickRefresh"></MudIconButton>
            <MudMenu Icon="@Icons.Material.Filled.MoreVert" AriaLabel="Open user menu">
                @foreach (var strmodulo in masterComp.Modules!)
                {
                    <MudMenuItem Label="@strmodulo.ActionDisplay" Icon="@(strmodulo.ActionDisplay.ToActionIcon())" IconColor="@Color.Info" OnClick="@(() => masterComp.ClickMenu(strmodulo.ActionName))" />
                }
            </MudMenu>
        </ToolBarContent>
        <Columns>
            <TemplateColumn>
                <HeaderTemplate>
                    <MudCheckBox @bind-Value="masterComp.IsAllCheckBoxSelected" @bind-Value:after="masterComp.AfterAsyncAllCheck" />
                </HeaderTemplate>
                <CellTemplate>
                    <MudCheckBox @bind-Value="@context.Item.IsSelected" />
                </CellTemplate>
            </TemplateColumn>
            <PropertyColumn Property="x => x.Name" title="ALMACEN" Sortable="false" Filterable="false" />
            <PropertyColumn Property="x => x.SupplierName" title="PLANTA" />
            <PropertyColumn Property="x => x.BrandName" title="MARCA" />
            <TemplateColumn>
                <HeaderTemplate>
                    <MudText>ACTIVO</MudText>
                </HeaderTemplate>
                <CellTemplate>                    
                    <MudIcon Icon="@(context.Item.IsActive ?? false ? Icons.Material.Filled.VerifiedUser : Icons.Material.Filled.Dangerous)" Color="@(context.Item.IsActive ?? false ? Color.Success : Color.Error)" Size="Size.Medium" />
                </CellTemplate>
            </TemplateColumn>
            <TemplateColumn>
                <CellTemplate>
                    <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Edit" OnClick="() => masterComp.ClickEdit(context.Item)" />
                </CellTemplate>
            </TemplateColumn>
        </Columns>
        <PagerContent>
            <MudDataGridPager T="Warehouse" PageSizeOptions="new int[] { 100 }" InfoFormat="{first_item}-{last_item} de {all_items}" RowsPerPageString="Registros por Pagina" />
        </PagerContent>
    </MudDataGrid>
}
else
{
    <WarehouseForm @bind-Value="WarehouseId" />
}

@code {
    [Inject] private MasterComp<Warehouse, WarehouseForm> masterComp { get; set; } = default!;
    private int? WarehouseId;
    List<BreadcrumbItem> ItemsNavigate = [new("Home", href: "", icon: Icons.Material.Filled.Home), new("Inventario", href: "warehouses", icon: Icons.Material.Filled.Inventory), new("Almacen", href: "warehouses", icon: Icons.Material.Filled.Warehouse)];
     

    protected override async Task OnInitializedAsync()
    {
       await masterComp.FillModules();
    }
    private async Task<GridData<Warehouse>> ServerReload(GridState<Warehouse> state)
    {
        masterComp.IsAllCheckBoxSelected = false;
        masterComp.loading = true;
        var mOffset = state.Page * state.PageSize;
        var totalItems = 0;
        IEnumerable<Warehouse> data;
        HttpResponseMessage response = await masterComp.Http.GetAsync($"api/Warehouse/GetAll?filter={masterComp.searchString}&rowFrom={mOffset}&userId={Useful.userId}");

        if (response.IsSuccessStatusCode)
        {
            var content2 = await response.Content.ReadFromJsonAsync<WebApiResponse<List<Warehouse>>>();
            totalItems = content2!.total ?? 0;
            data = content2!.data ?? new List<Warehouse>();
        }
        else
        {
            var errorMessage = await response.Content.ReadAsStringAsync();
            throw new Exception(errorMessage);
        }
        masterComp.loading = false;

        return new GridData<Warehouse> { TotalItems = totalItems, Items = data };
    }
   
}